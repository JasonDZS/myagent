<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Trace Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .trace-selector {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            font-size: 0.875rem;
            min-width: 300px;
            cursor: pointer;
        }

        .trace-selector:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .sidebar-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .runs-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .run-tree-item {
            margin-bottom: 0.25rem;
        }

        .run-tree-item.nested {
            margin-left: 1.5rem;
            border-left: 2px solid #e2e8f0;
            padding-left: 1rem;
        }

        .run-item-header {
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .run-item-header:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .run-item-header.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .run-item-icon {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .run-item-icon.agent {
            background: #3b82f6;
        }

        .run-item-icon.tool {
            background: #10b981;
        }

        .run-item-icon.think {
            background: #f59e0b;
        }

        .run-item-icon.act {
            background: #8b5cf6;
        }

        .run-item-icon.llm {
            background: #ef4444;
        }

        .run-item-content {
            flex: 1;
            min-width: 0;
        }

        .run-item-name {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .run-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .run-item-status {
            padding: 0.125rem 0.25rem;
            border-radius: 0.125rem;
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
        }

        .status-running {
            background: #fef3c7;
            color: #92400e;
        }

        .run-item-duration {
            color: #059669;
        }

        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .content-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .content-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .tab:not(.active) {
            color: #64748b;
        }

        .tab:not(.active):hover {
            background: #f1f5f9;
            color: #374151;
        }

        .run-details {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .run-details-container {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            height: 100%;
        }

        .run-details-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .run-details-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .run-details-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .run-details-content {
            padding: 1rem;
            height: calc(100% - 80px);
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.75rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .timing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.75rem;
        }

        .timing-item {
            text-align: center;
        }

        .timing-label {
            font-size: 0.625rem;
            color: #64748b;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .timing-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
            text-align: center;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .no-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
            text-align: center;
        }

        .no-selection-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #64748b;
        }

        .error {
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem;
        }

        .duration {
            color: #059669;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üîç TRACE</h1>
            <select class="trace-selector" id="traceSelector" onchange="selectTrace()">
                <option value="">Select a trace...</option>
            </select>
        </div>
        <button class="refresh-btn" onclick="refreshTraces()">Refresh</button>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Execution Tree</div>
            </div>
            <div class="runs-list" id="runsList">
                <div class="empty-state">
                    <div class="empty-icon">üå≥</div>
                    <p>Select a trace to view execution tree</p>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="content-header">
                <div class="content-title" id="contentTitle">Run Details</div>
                <div class="content-tabs">
                    <div class="tab active" data-tab="input">Input</div>
                    <div class="tab" data-tab="output">Output</div>
                    <div class="tab" data-tab="metadata">Metadata</div>
                </div>
            </div>
            <div class="run-details">
                <div class="no-selection" id="noSelection">
                    <div class="no-selection-icon">üìã</div>
                    <p>Select a run from the execution tree to view details</p>
                </div>
                <div class="run-details-container" id="runDetailsContainer" style="display: none;">
                    <div class="run-details-header">
                        <div class="run-details-title" id="runDetailsTitle">Run Details</div>
                        <div class="run-details-meta" id="runDetailsMeta"></div>
                    </div>
                    <div class="run-details-content" id="runDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allTraces = [];
        let selectedTrace = null;
        let selectedRun = null;
        let activeTab = 'input';

        async function loadTraces() {
            try {
                const response = await fetch('/api/traces/all');
                const data = await response.json();
                
                if (data.success) {
                    allTraces = data.traces;
                    populateTraceSelector();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                console.error('Error loading traces:', error);
                const selector = document.getElementById('traceSelector');
                selector.innerHTML = '<option value="">Error loading traces</option>';
            }
        }

        function populateTraceSelector() {
            const selector = document.getElementById('traceSelector');
            selector.innerHTML = '<option value="">Select a trace...</option>';
            
            allTraces.forEach((trace, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${trace.name || trace.id || 'Unnamed Trace'} (${trace.runs ? trace.runs.length : 0} runs)`;
                selector.appendChild(option);
            });
        }

        function selectTrace() {
            const selector = document.getElementById('traceSelector');
            const selectedIndex = selector.value;
            
            if (selectedIndex === '') {
                selectedTrace = null;
                selectedRun = null;
                renderEmptyRunsList();
                renderEmptyRunDetails();
                return;
            }
            
            selectedTrace = allTraces[selectedIndex];
            selectedRun = null;
            renderRunsTree();
            renderEmptyRunDetails();
        }

        function renderEmptyRunsList() {
            const runsList = document.getElementById('runsList');
            runsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üå≥</div>
                    <p>Select a trace to view execution tree</p>
                </div>
            `;
        }

        function renderRunsTree() {
            const runsList = document.getElementById('runsList');
            
            if (!selectedTrace || !selectedTrace.runs || selectedTrace.runs.length === 0) {
                runsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö°</div>
                        <p>No runs found for this trace</p>
                    </div>
                `;
                return;
            }

            // Build tree structure
            const runs = selectedTrace.runs;
            const runMap = new Map();
            const rootRuns = [];
            
            // First pass: create map of all runs
            runs.forEach(run => {
                runMap.set(run.id, { ...run, children: [] });
            });
            
            // Second pass: build tree structure
            runs.forEach(run => {
                if (run.parent_run_id && runMap.has(run.parent_run_id)) {
                    runMap.get(run.parent_run_id).children.push(runMap.get(run.id));
                } else {
                    rootRuns.push(runMap.get(run.id));
                }
            });
            
            runsList.innerHTML = rootRuns.map(run => renderRunTreeItem(run, 0)).join('');
        }

        function renderRunTreeItem(run, level) {
            const runType = run.run_type || 'unknown';
            const iconText = getRunIcon(runType);
            const duration = calculateDuration(run.start_time, run.end_time);
            const statusClass = getStatusClass(run.status);
            
            let html = `
                <div class="run-tree-item ${level > 0 ? 'nested' : ''}">
                    <div class="run-item-header" onclick="selectRun('${run.id}')" data-run-id="${run.id}">
                        <div class="run-item-icon ${runType}">${iconText}</div>
                        <div class="run-item-content">
                            <div class="run-item-name">${run.name || runType}</div>
                            <div class="run-item-meta">
                                <span class="run-item-status status-${statusClass}">${run.status || 'unknown'}</span>
                                ${duration ? `<span class="run-item-duration">${duration}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add children if any
            if (run.children && run.children.length > 0) {
                html += run.children.map(child => renderRunTreeItem(child, level + 1)).join('');
            }
            
            return html;
        }

        function getRunIcon(runType) {
            const icons = {
                'agent': 'A',
                'tool': 'T',
                'think': 'T',
                'act': 'A',
                'llm': 'L'
            };
            return icons[runType] || '?';
        }

        function getStatusClass(status) {
            if (status === 'success' || status === 'completed') return 'success';
            if (status === 'error' || status === 'failed') return 'error';
            return 'running';
        }

        function selectRun(runId) {
            if (!selectedTrace || !selectedTrace.runs) return;
            
            selectedRun = selectedTrace.runs.find(run => run.id === runId);
            
            // Update selection in tree
            document.querySelectorAll('.run-item-header').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-run-id="${runId}"]`).classList.add('selected');
            
            renderRunDetails();
        }

        function renderEmptyRunDetails() {
            document.getElementById('noSelection').style.display = 'flex';
            document.getElementById('runDetailsContainer').style.display = 'none';
        }

        function renderRunDetails() {
            if (!selectedRun) {
                renderEmptyRunDetails();
                return;
            }
            
            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('runDetailsContainer').style.display = 'block';
            
            // Update header
            document.getElementById('runDetailsTitle').textContent = selectedRun.name || selectedRun.run_type || 'Unnamed Run';
            
            const meta = document.getElementById('runDetailsMeta');
            const duration = calculateDuration(selectedRun.start_time, selectedRun.end_time);
            const statusClass = getStatusClass(selectedRun.status);
            
            meta.innerHTML = `
                <span class="run-item-status status-${statusClass}">${selectedRun.status || 'unknown'}</span>
                <span>${selectedRun.run_type || 'unknown'}</span>
                ${duration ? `<span class="duration">${duration}</span>` : ''}
            `;
            
            renderRunDetailsContent();
        }

        function renderRunDetailsContent() {
            const content = document.getElementById('runDetailsContent');
            
            if (activeTab === 'input') {
                renderInputTab(content);
            } else if (activeTab === 'output') {
                renderOutputTab(content);
            } else if (activeTab === 'metadata') {
                renderMetadataTab(content);
            }
        }

        function renderInputTab(container) {
            let html = '';
            
            // Timing information
            if (selectedRun.start_time || selectedRun.end_time || selectedRun.latency_ms) {
                html += `
                    <div class="detail-section">
                        <div class="detail-label">Timing</div>
                        <div class="timing-grid">
                            ${selectedRun.start_time ? `
                                <div class="timing-item">
                                    <div class="timing-label">Start</div>
                                    <div class="timing-value">${formatTime(selectedRun.start_time)}</div>
                                </div>
                            ` : ''}
                            ${selectedRun.end_time ? `
                                <div class="timing-item">
                                    <div class="timing-label">End</div>
                                    <div class="timing-value">${formatTime(selectedRun.end_time)}</div>
                                </div>
                            ` : ''}
                            ${selectedRun.latency_ms ? `
                                <div class="timing-item">
                                    <div class="timing-label">Duration</div>
                                    <div class="timing-value">${selectedRun.latency_ms}ms</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Inputs
            if (selectedRun.inputs && Object.keys(selectedRun.inputs).length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-label">Input</div>
                        <div class="detail-value">${JSON.stringify(selectedRun.inputs, null, 2)}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div class="detail-section"><div class="detail-value">No input data available</div></div>';
        }

        function renderOutputTab(container) {
            let html = '';
            
            // Outputs
            if (selectedRun.outputs && Object.keys(selectedRun.outputs).length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-label">Output</div>
                        <div class="detail-value">${JSON.stringify(selectedRun.outputs, null, 2)}</div>
                    </div>
                `;
            }
            
            // Error information
            if (selectedRun.error) {
                html += `
                    <div class="detail-section">
                        <div class="detail-label">Error</div>
                        <div class="detail-value" style="background: #fef2f2; border-color: #fecaca; color: #dc2626;">${selectedRun.error}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div class="detail-section"><div class="detail-value">No output data available</div></div>';
        }

        function renderMetadataTab(container) {
            let html = '';
            
            // Token usage (for LLM runs)
            if (selectedRun.token_usage) {
                html += `
                    <div class="detail-section">
                        <div class="detail-label">Token Usage</div>
                        <div class="detail-value">${JSON.stringify(selectedRun.token_usage, null, 2)}</div>
                    </div>
                `;
            }
            
            // Metadata
            if (selectedRun.metadata && Object.keys(selectedRun.metadata).length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-label">Metadata</div>
                        <div class="detail-value">${JSON.stringify(selectedRun.metadata, null, 2)}</div>
                    </div>
                `;
            }
            
            // Basic run information
            const basicInfo = {
                'Run ID': selectedRun.id,
                'Run Type': selectedRun.run_type,
                'Status': selectedRun.status,
                'Parent Run ID': selectedRun.parent_run_id,
                'Trace ID': selectedRun.trace_id
            };
            
            html += `
                <div class="detail-section">
                    <div class="detail-label">Run Information</div>
                    <div class="detail-value">${JSON.stringify(basicInfo, null, 2)}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            try {
                return new Date(dateString).toLocaleTimeString();
            } catch {
                return dateString;
            }
        }

        function calculateDuration(start, end) {
            if (!start || !end) return null;
            
            try {
                const startTime = new Date(start.replace('Z', '+00:00'));
                const endTime = new Date(end.replace('Z', '+00:00'));
                const durationMs = endTime - startTime;
                
                if (durationMs < 1000) {
                    return `${durationMs}ms`;
                } else {
                    return `${(durationMs / 1000).toFixed(2)}s`;
                }
            } catch {
                return null;
            }
        }

        function refreshTraces() {
            loadTraces();
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeTab = tab.dataset.tab;
                
                if (selectedRun) {
                    renderRunDetailsContent();
                }
            });
        });

        // Initialize
        loadTraces();
    </script>
</body>
</html>