<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyAgent WebSocket å®¢æˆ·ç«¯æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
        }
        .message.user {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
        }
        .message.agent {
            background-color: #28a745;
            color: white;
            margin-right: 20%;
        }
        .message.system {
            background-color: #6c757d;
            color: white;
            font-size: 0.9em;
            text-align: center;
        }
        .message.thinking {
            background-color: #ffc107;
            color: #212529;
            font-style: italic;
            margin-right: 20%;
        }
        .message.tool {
            background-color: #17a2b8;
            color: white;
            margin-right: 20%;
            font-family: monospace;
            font-size: 0.9em;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        .input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .input-container button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .input-container button:hover {
            background-color: #0056b3;
        }
        .input-container button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .config {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .config label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .config input[type="text"] {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .examples {
            margin-top: 20px;
        }
        .example-btn {
            margin: 5px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .example-btn:hover {
            background-color: #e9ecef;
        }
        .timestamp {
            font-size: 0.8em;
            opacity: 0.7;
            float: right;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– MyAgent WebSocket å®¢æˆ·ç«¯æ¼”ç¤º</h1>

    <div class="container">
        <h3>è¿æ¥é…ç½®</h3>
        <div class="config">
            <label>
                æœåŠ¡åœ°å€:
                <input type="text" id="wsUrl" value="ws://localhost:8080" style="width: 200px;">
            </label>
            <button id="connectBtn" onclick="toggleConnection()">è¿æ¥</button>
            <button id="clearBtn" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
        </div>
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
    </div>

    <div class="container">
        <h3>å¯¹è¯ç•Œé¢</h3>
        <div id="chatContainer" class="chat-container"></div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." disabled onkeypress="handleKeyPress(event)">
            <button id="sendBtn" onclick="sendMessage()" disabled>å‘é€</button>
        </div>

        <div class="examples">
            <h4>ç¤ºä¾‹é—®é¢˜ (ç‚¹å‡»å¿«é€Ÿå‘é€):</h4>
            <button class="example-btn" onclick="sendExampleMessage('ä½ å¥½ï¼')">ä½ å¥½ï¼</button>
            <button class="example-btn" onclick="sendExampleMessage('åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ')">æŸ¥è¯¢å¤©æ°”</button>
            <button class="example-btn" onclick="sendExampleMessage('å‘Šè¯‰æˆ‘ä¸Šæµ·çš„åŸºæœ¬ä¿¡æ¯')">åŸå¸‚ä¿¡æ¯</button>
            <button class="example-btn" onclick="sendExampleMessage('å¸®æˆ‘ä»‹ç»ä¸€ä¸‹æ·±åœ³è¿™ä¸ªåŸå¸‚')">ä»‹ç»æ·±åœ³</button>
            <button class="example-btn" onclick="sendExampleMessage('å¹¿å·çš„å¤©æ°”å¦‚ä½•ï¼Ÿ')">å¹¿å·å¤©æ°”</button>
        </div>
    </div>

    <div class="container">
        <h3>ä½¿ç”¨è¯´æ˜</h3>
        <ol>
            <li>ç¡®ä¿ MyAgent WebSocket æœåŠ¡æ­£åœ¨è¿è¡Œï¼š<code>myagent-ws server examples/ws_weather_agent.py</code></li>
            <li>ç‚¹å‡»"è¿æ¥"æŒ‰é’®è¿æ¥åˆ°æœåŠ¡å™¨</li>
            <li>è¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨åˆ›å»ºä¼šè¯</li>
            <li>è¾“å…¥æ¶ˆæ¯æˆ–ç‚¹å‡»ç¤ºä¾‹é—®é¢˜å¼€å§‹å¯¹è¯</li>
            <li>è§‚å¯Ÿ Agent çš„æ€è€ƒè¿‡ç¨‹å’Œå·¥å…·è°ƒç”¨</li>
        </ol>
    </div>

    <script>
        let ws = null;
        let sessionId = null;
        let isConnected = false;

        function updateStatus(message, type = 'disconnected') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function addMessage(content, type = 'system', metadata = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            let messageContent = content;

            if (metadata) {
                if (metadata.tool) {
                    messageContent = `ğŸ”§ ${metadata.tool}: ${content}`;
                }
                if (metadata.step) {
                    messageContent = `ğŸ’­ æ­¥éª¤ ${metadata.step}: ${content}`;
                }
            }

            messageEl.innerHTML = `
                <div>${messageContent}</div>
                <span class="timestamp">${timestamp}</span>
            `;

            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleConnection() {
            if (!isConnected) {
                connect();
            } else {
                disconnect();
            }
        }

        function connect() {
            const wsUrl = document.getElementById('wsUrl').value;
            updateStatus('æ­£åœ¨è¿æ¥...', 'connecting');

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    isConnected = true;
                    updateStatus('å·²è¿æ¥', 'connected');
                    document.getElementById('connectBtn').textContent = 'æ–­å¼€';
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;

                    addMessage('WebSocket è¿æ¥å·²å»ºç«‹', 'system');

                    // è‡ªåŠ¨åˆ›å»ºä¼šè¯
                    createSession();
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };

                ws.onclose = () => {
                    isConnected = false;
                    sessionId = null;
                    updateStatus('è¿æ¥å·²æ–­å¼€', 'disconnected');
                    document.getElementById('connectBtn').textContent = 'è¿æ¥';
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendBtn').disabled = true;

                    addMessage('WebSocket è¿æ¥å·²æ–­å¼€', 'system');
                };

                ws.onerror = (error) => {
                    console.error('WebSocket é”™è¯¯:', error);
                    addMessage('è¿æ¥å‡ºé”™ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨', 'system');
                };

            } catch (error) {
                updateStatus('è¿æ¥å¤±è´¥', 'disconnected');
                addMessage(`è¿æ¥å¤±è´¥: ${error.message}`, 'system');
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function createSession() {
            const message = {
                event: 'user.create_session',
                timestamp: new Date().toISOString()
            };

            ws.send(JSON.stringify(message));
        }

        function handleMessage(data) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', data);

            switch (data.event) {
                case 'system.connected':
                    addMessage(`è¿æ¥æˆåŠŸ (ID: ${data.metadata?.connection_id?.slice(-8)})`, 'system');
                    break;

                case 'agent.session_created':
                    sessionId = data.session_id;
                    addMessage(`ä¼šè¯åˆ›å»ºæˆåŠŸ (ID: ${sessionId.slice(-8)})`, 'system');
                    addMessage('æ‚¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼', 'system');
                    break;

                case 'agent.thinking':
                    addMessage(data.content, 'thinking', data.metadata);
                    break;

                case 'agent.tool_call':
                    const toolInfo = `è°ƒç”¨å·¥å…·: ${data.metadata?.tool}`;
                    addMessage(toolInfo, 'tool', data.metadata);
                    break;

                case 'agent.tool_result':
                    const resultInfo = `å·¥å…·ç»“æœ: ${data.content}`;
                    addMessage(resultInfo, 'tool', data.metadata);
                    break;

                case 'agent.partial_answer':
                    addMessage(data.content, 'agent');
                    break;

                case 'agent.final_answer':
                    addMessage(data.content, 'agent');
                    break;

                case 'agent.error':
                    addMessage(`âŒ é”™è¯¯: ${data.content}`, 'system');
                    break;

                case 'system.heartbeat':
                    // å¿ƒè·³æ¶ˆæ¯ï¼Œä¸æ˜¾ç¤º
                    break;

                default:
                    addMessage(`${data.event}: ${data.content || JSON.stringify(data)}`, 'system');
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !sessionId) {
                return;
            }

            addMessage(message, 'user');

            const wsMessage = {
                event: 'user.message',
                session_id: sessionId,
                content: message,
                timestamp: new Date().toISOString()
            };

            ws.send(JSON.stringify(wsMessage));
            input.value = '';
        }

        function sendExampleMessage(message) {
            if (!isConnected || !sessionId) {
                alert('è¯·å…ˆè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }

            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            addMessage('æ¬¢è¿ä½¿ç”¨ MyAgent WebSocket å®¢æˆ·ç«¯ï¼', 'system');
            addMessage('è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œç„¶åç‚¹å‡»è¿æ¥æŒ‰é’®ã€‚', 'system');
        };
    </script>
</body>
</html>
