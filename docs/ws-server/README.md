# MyAgent WebSocket æ–‡æ¡£ä¸­å¿ƒ

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸš€ å¿«é€Ÿå¼€å§‹
- [**WebSocket æ¨¡å—å®Œæ•´æŒ‡å—**](./ws-guide_zh.md) - â­ æ¨èï¼å®Œæ•´çš„æ¨¡å—ä½¿ç”¨æŒ‡å—
- [**åŸºç¡€æ¦‚å¿µ**](./basic-concepts.md) - WebSocketåè®®ã€äº‹ä»¶ç³»ç»Ÿå’Œæ ¸å¿ƒæ¦‚å¿µ
- [**é€šç”¨åè®®æ–¹æ¡ˆ**](./universal-client-protocol.md) - å®Œæ•´çš„é€šç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡åè®®
- [**å¿«é€Ÿå¼€å§‹**](./quick-start.md) - 5åˆ†é’Ÿä¸Šæ‰‹ï¼Œæ”¯æŒHTMLã€Node.jsã€Python
- [**æ—¶åºå›¾**](./sequence-diagram.md) - å®Œæ•´çš„æ¶ˆæ¯äº¤äº’æµç¨‹å›¾

### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½
- [**ç”¨æˆ·ç¡®è®¤æœºåˆ¶**](./user-confirmation.md) - å±é™©æ“ä½œçš„ç¡®è®¤æµç¨‹å®ç°
- [**å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†**](./client-state-management.md) - ä¼šè¯çŠ¶æ€çš„å®¢æˆ·ç«¯å­˜å‚¨å’Œæ¢å¤
- [**æ•°æ®å¯è§†åŒ–é›†æˆ**](./visualization-integration.md) - EChartså›¾è¡¨å¯è§†åŒ–æ”¯æŒ
- [**Plan & Solve æ¶ˆæ¯æŒ‡å—**](./plan_solver_messages.md) - è§„åˆ’/æ±‚è§£æµæ°´çº¿ä¸ç»†ç²’åº¦æ§åˆ¶

### ğŸ¯ æ¡†æ¶é›†æˆ
- [**React é›†æˆ**](./react-integration.md) - å®Œæ•´çš„React Hookå’Œç»„ä»¶å®ç°

## ğŸ¯ é€‰æ‹©ä½ çš„æ–¹æ¡ˆ

### æˆ‘æƒ³å…¨é¢äº†è§£ WebSocket æ¨¡å—
ğŸ‘‰ é˜…è¯» [**WebSocket æ¨¡å—å®Œæ•´æŒ‡å—**](./ws-guide_zh.md) - åŒ…å«æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ã€å¼€å‘ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

### æˆ‘æ˜¯å‰ç«¯æ–°æ‰‹
ğŸ‘‰ ä» [**å¿«é€Ÿå¼€å§‹**](./quick-start.md) å¼€å§‹ï¼Œä½¿ç”¨ HTML+JavaScript ç‰ˆæœ¬

### æˆ‘ä½¿ç”¨ React
ğŸ‘‰ ç›´æ¥æŸ¥çœ‹ [**React é›†æˆ**](./react-integration.md)ï¼Œè·å–å®Œæ•´çš„Hookå’Œç»„ä»¶

### æˆ‘ä½¿ç”¨ Vue
ğŸ‘‰ æŸ¥çœ‹ [**æ•°æ®å¯è§†åŒ–é›†æˆ**](./visualization-integration.md)ï¼Œå›¾è¡¨å±•ç¤ºåŠŸèƒ½

### æˆ‘éœ€è¦äº†è§£åè®®ç»†èŠ‚
ğŸ‘‰ é˜…è¯» [**åŸºç¡€æ¦‚å¿µ**](./basic-concepts.md) å’Œ [**é€šç”¨åè®®æ–¹æ¡ˆ**](./universal-client-protocol.md)

### æˆ‘éœ€è¦å¼€å‘æœåŠ¡å™¨ç«¯
ğŸ‘‰ æŸ¥çœ‹ [**WebSocket æ¨¡å—å®Œæ•´æŒ‡å—**](./ws-guide_zh.md) çš„æœåŠ¡å™¨ç«¯å¼€å‘ç« èŠ‚

### æˆ‘çš„åº”ç”¨éœ€è¦ç”¨æˆ·ç¡®è®¤
ğŸ‘‰ é‡ç‚¹å…³æ³¨ [**ç”¨æˆ·ç¡®è®¤æœºåˆ¶**](./user-confirmation.md)

### æˆ‘éœ€è¦ä¼šè¯çŠ¶æ€æŒä¹…åŒ–
ğŸ‘‰ æŸ¥çœ‹ [**å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†**](./client-state-management.md)ï¼Œå®ç°ç¦»çº¿çŠ¶æ€æ¢å¤

## âš¡ æ ¸å¿ƒç‰¹æ€§ä¸€è§ˆ

### ğŸ”„ å®æ—¶åŒå‘é€šä¿¡
- WebSocketé•¿è¿æ¥ï¼Œä½å»¶è¿Ÿäº¤äº’
- è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œå¤„ç†ç½‘ç»œå¼‚å¸¸
- å¿ƒè·³æ£€æµ‹ï¼Œç»´æŒè¿æ¥å¥åº·
- ç‰ˆæœ¬å…¼å®¹çš„WebSocketå·¥å…·å‡½æ•°

### ğŸ§  Agentäº¤äº’æ”¯æŒ
- æ€è€ƒçŠ¶æ€å®æ—¶æ˜¾ç¤º
- æµå¼å›ç­”ï¼Œé€æ­¥å±•ç¤ºç»“æœ
- å·¥å…·è°ƒç”¨è¿‡ç¨‹å¯è§†åŒ–
- Agentè¿è¡Œæ—¶çŠ¶æ€è·Ÿè¸ª

### âš ï¸ ç”¨æˆ·ç¡®è®¤æœºåˆ¶
- å±é™©æ“ä½œå‰å¼ºåˆ¶ç¡®è®¤
- å‚æ•°è¯¦æƒ…å±•ç¤º
- è‡ªå®šä¹‰ç¡®è®¤æ¶ˆæ¯
- è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆ5åˆ†é’Ÿï¼‰

### ğŸ’¾ å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†
- ä¼šè¯çŠ¶æ€å®¢æˆ·ç«¯å­˜å‚¨ï¼ˆåŸºäº `StateManager`ï¼‰
- ç¦»çº¿åçŠ¶æ€æ¢å¤
- HMAC-SHA256 å®‰å…¨ç­¾åéªŒè¯
- è·¨è®¾å¤‡çŠ¶æ€è¿ç§»
- çŠ¶æ€æœ‰æ•ˆæœŸï¼ˆ7å¤©ï¼‰
- æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨æ¸…ç†
- çŠ¶æ€å¤§å°é™åˆ¶ï¼ˆ100KBï¼‰

### ğŸ›¡ï¸ å¯é æ€§ä¸æµæ§ï¼ˆæ–°å¢ï¼‰
- äº‹ä»¶å¸¦å•è°ƒ `seq` ä¸å…¨å±€å”¯ä¸€ `event_id`ï¼ˆ`<connectionId>-<seq>`ï¼‰
- å®¢æˆ·ç«¯é€šè¿‡ `user.ack` å›ä¼  `last_event_id` æˆ– `last_seq`ï¼ŒæœåŠ¡ç«¯æ®æ­¤è£å‰ªç¼“å†²
- æ–­çº¿é‡è¿å¯å¸¦ä¸Šæ¬¡ `last_event_id/last_seq`ï¼ŒæœåŠ¡ç«¯æŒ‰ä¼šè¯ç¼“å†²åšâ€œå·®é‡å›æ”¾â€ï¼ˆæœ€å¤š200æ¡ï¼‰
- æ¯è¿æ¥å•å†™è€…å‡ºç«™é€šé“ä¸æœ‰ç•Œé˜Ÿåˆ—ï¼Œé¿å…å¹¶å‘ `send()` ä¸æ— ç•Œå†…å­˜
- é«˜é¢‘äº‹ä»¶åˆå¹¶ï¼š`agent.partial_answer`ã€`agent.llm_message` é»˜è®¤75msçª—å£ä»…ä¿ç•™æœ€æ–°

### ğŸ“± å¤šç«¯é€‚é…
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
- å®Œæ•´çš„é”®ç›˜å¿«æ·é”®æ”¯æŒ
- å¯è®¿é—®æ€§ä¼˜åŒ–

## ğŸ“‹ äº‹ä»¶ç±»å‹é€ŸæŸ¥

### ç”¨æˆ·äº‹ä»¶ (å‘é€)
```javascript
user.create_session         // åˆ›å»ºä¼šè¯
user.message               // å‘é€æ¶ˆæ¯
user.solve_tasks           // ç›´æ¥æäº¤ä»»åŠ¡ç»™æ±‚è§£å™¨ï¼ˆè·³è¿‡è§„åˆ’ï¼‰
user.response              // ç¡®è®¤å“åº”ï¼ˆå« step_idï¼‰
user.cancel                // å–æ¶ˆå½“å‰æ‰§è¡Œ
user.cancel_task           // å–æ¶ˆæŒ‡å®šä»»åŠ¡ï¼ˆç»†ç²’åº¦ï¼‰
user.restart_task          // é‡å¯æŒ‡å®šä»»åŠ¡ï¼ˆç»†ç²’åº¦ï¼‰
user.cancel_plan           // å–æ¶ˆè§„åˆ’é˜¶æ®µ
user.replan                // é‡æ–°è§„åˆ’ï¼ˆä¼šè¯ç©ºé—²æˆ–è¿è¡Œå†…é‡è®¡åˆ’ï¼‰
user.request_state         // è¯·æ±‚å¯¼å‡ºçŠ¶æ€
user.reconnect_with_state  // ä½¿ç”¨çŠ¶æ€é‡è¿
user.ack                   // å®¢æˆ·ç«¯ACKï¼Œæºå¸¦ last_event_id æˆ– last_seq
```

### Agentäº‹ä»¶ (æ¥æ”¶)
```javascript
agent.session_created  // ä¼šè¯åˆ›å»ºæˆåŠŸ
agent.thinking         // æ€è€ƒçŠ¶æ€
agent.tool_call        // å·¥å…·è°ƒç”¨
agent.tool_result      // å·¥å…·ç»“æœ
agent.user_confirm     // è¯·æ±‚ç¡®è®¤
agent.partial_answer   // æµå¼å›ç­”
agent.final_answer     // æœ€ç»ˆå›ç­”
agent.state_exported   // çŠ¶æ€å¯¼å‡ºå®Œæˆ
agent.state_restored   // çŠ¶æ€æ¢å¤å®Œæˆ
agent.error           // æ‰§è¡Œé”™è¯¯
agent.llm_message     // LLMåŸå§‹æ¶ˆæ¯ï¼ˆè°ƒè¯•/å¯è§†åŒ–ï¼‰
plan.cancelled        // è§„åˆ’è¢«å–æ¶ˆ
solver.cancelled      // å•ä»»åŠ¡è¢«å–æ¶ˆ
solver.restarted      // å•ä»»åŠ¡å·²é‡å¯
```

### ç³»ç»Ÿäº‹ä»¶ (æ¥æ”¶)
```javascript
system.connected    // è¿æ¥ç¡®è®¤
system.heartbeat    // å¿ƒè·³æ£€æµ‹
system.error        // ç³»ç»Ÿé”™è¯¯
```

## ğŸ”§ åŸºç¡€æ¶ˆæ¯æ ¼å¼

```typescript
interface WebSocketMessage {
  event: string;           // äº‹ä»¶ç±»å‹
  timestamp: string;       // ISOæ—¶é—´æˆ³
  session_id?: string;     // ä¼šè¯ID (éç³»ç»Ÿäº‹ä»¶å¿…éœ€)
  step_id?: string;        // æ­¥éª¤ID (ç”¨äºè¯·æ±‚å“åº”å…³è”)
  content?: string | object; // æ¶ˆæ¯å†…å®¹
  metadata?: object;       // å…ƒæ•°æ®
  // ä»¥ä¸‹å­—æ®µç”±æœåŠ¡å™¨ä¸‹è¡Œäº‹ä»¶é™„å¸¦ï¼Œç”¨äºå¯é æ€§ï¼š
  seq?: number;            // è¿æ¥å†…å•è°ƒåºå·
  event_id?: string;       // å…¨å±€å”¯ä¸€äº‹ä»¶ID: <connectionId>-<seq>
}
```

### å®¢æˆ·ç«¯ ACK å»ºè®®
- æ¯æ”¶åˆ°è‹¥å¹²æ¡äº‹ä»¶æˆ–æ¯200mså‘é€ä¸€æ¬¡ ACKï¼ˆèŠ‚æµå³å¯ï¼‰
- ä¼˜å…ˆä½¿ç”¨ `last_event_id`ï¼Œæ— æ³•è·å–æ—¶ä½¿ç”¨ `last_seq`

ç¤ºä¾‹ï¼š
```javascript
// ç»´æŠ¤æœ€è¿‘æ”¶åˆ°çš„ event_id/seq
let lastEventId = null;
let lastSeq = 0;

ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (typeof msg.event_id === 'string') lastEventId = msg.event_id;
  if (typeof msg.seq === 'number') lastSeq = msg.seq;
};

// å®šæ—¶èŠ‚æµ ACKï¼ˆ200msï¼‰
setInterval(() => {
  if (ws.readyState !== WebSocket.OPEN) return;
  const content = lastEventId ? { last_event_id: lastEventId } : { last_seq: lastSeq };
  ws.send(JSON.stringify({ event: 'user.ack', content }));
}, 200);
```

## ğŸš€ å¿«é€Ÿç¤ºä¾‹

### åŸºç¡€è¿æ¥
```javascript
const ws = new WebSocket('ws://localhost:8080');

ws.onopen = () => {
    // åˆ›å»ºä¼šè¯
    ws.send(JSON.stringify({
        event: 'user.create_session',
        timestamp: new Date().toISOString(),
        content: 'create_session'
    }));
};

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
    
    if (data.event === 'agent.session_created') {
        // å‘é€æµ‹è¯•æ¶ˆæ¯
        ws.send(JSON.stringify({
            session_id: data.session_id,
            event: 'user.message',
            timestamp: new Date().toISOString(),
            content: 'ä½ å¥½ï¼'
        }));
    }
};
```

### ç›´æ¥ä»»åŠ¡æ¨¡å¼ï¼ˆè·³è¿‡è§„åˆ’ï¼‰
```javascript
// åœ¨æ”¶åˆ° agent.session_created åï¼š
ws.send(JSON.stringify({
  event: 'user.solve_tasks',
  session_id: data.session_id, // æˆ–ç¼“å­˜çš„ sessionId
  content: {
    tasks: [{ id: 1, title: 'ç¤ºä¾‹', objective: '...' }],
    question: 'å¯é€‰ï¼Œé—®é¢˜èƒŒæ™¯',
    plan_summary: 'å¯é€‰ï¼Œè®¡åˆ’æ‘˜è¦'
  }
}));
// ä»…ä¼šæ”¶åˆ° solver.start / solver.completed ç­‰æ±‚è§£ç›¸å…³äº‹ä»¶
```

### React Hook ä½¿ç”¨
```typescript
function ChatApp() {
    const { 
        connected, 
        messages, 
        sendMessage, 
        pendingConfirmation,
        respondToConfirmation 
    } = useMyAgent();

    return (
        <div>
            {messages.map(msg => (
                <div key={msg.id}>{msg.content}</div>
            ))}
            
            {pendingConfirmation && (
                <ConfirmationDialog 
                    confirmation={pendingConfirmation}
                    onConfirm={respondToConfirmation}
                />
            )}
            
            <input onKeyPress={(e) => {
                if (e.key === 'Enter') {
                    sendMessage(e.target.value);
                    e.target.value = '';
                }
            }} />
        </div>
    );
}
```

## ğŸ›Ÿ è·å–å¸®åŠ©

### å¸¸è§é—®é¢˜
æŸ¥çœ‹ [**åŸºç¡€æ¦‚å¿µæ–‡æ¡£**](./basic-concepts.md)ï¼Œäº†è§£æ›´å¤šæŠ€æœ¯ç»†èŠ‚ã€‚

### é—®é¢˜æŠ¥å‘Š
å¦‚æœä½ å‘ç°äº†æ–‡æ¡£ä¸­çš„é”™è¯¯æˆ–éœ€è¦æ–°åŠŸèƒ½ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆã€‚

### ç¤¾åŒºæ”¯æŒ
åŠ å…¥æˆ‘ä»¬çš„å¼€å‘è€…ç¤¾åŒºï¼Œä¸å…¶ä»–å¼€å‘è€…äº¤æµç»éªŒã€‚

---

**å¿«é€Ÿå¼€å§‹** ğŸ‘‰ é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„æ–‡æ¡£å¼€å§‹å§ï¼
