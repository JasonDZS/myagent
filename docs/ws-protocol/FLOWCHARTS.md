# WebSocket 事件系统流程图

## 1. 正常工作流程

### 完整的规划→求解→聚合流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端                                    │
└─────────────────────────────────────────────────────────────────┘
              │
              │ user.message / user.solve_tasks
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        服务端                                    │
│                   规划 (Planning Stage)                          │
└─────────────────────────────────────────────────────────────────┘
              │
              ├─ plan.start (开始规划)
              │
              ├─ plan.step_completed (步骤完成) × N
              │
              ├─ plan.completed (规划完成)
              │   └─ metadata: { tasks: [...], plan_summary: "..." }
              │
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       用户确认                                   │
└─────────────────────────────────────────────────────────────────┘
              │
              ├─ agent.user_confirm (请求确认)
              │  └─ step_id: "confirm_plan_abc123"
              │
    ┌─────────────────────────────────────┐
    │  客户端收到确认请求                   │
    │  用户编辑任务（可选）                 │
    │  点击"确认"按钮                       │
    └─────────────────────────────────────┘
              │
              │ user.response
              │ └─ metadata: { step_id: "confirm_plan_abc123", confirmed: true }
              │
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   求解 (Solver Stage)                           │
└─────────────────────────────────────────────────────────────────┘
              │
       ┌──────┴──────┐
       │             │
       ↓             ↓
   [任务 1]      [任务 2]  (并行或串行)
   solver.start  solver.start
   solver.progress solver.progress
   solver.progress solver.progress
   solver.completed solver.completed
       │             │
       └──────┬──────┘
              │
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  聚合 (Aggregation Stage)                        │
└─────────────────────────────────────────────────────────────────┘
              │
              ├─ aggregate.start
              │
              ├─ aggregate.completed
              │
              ↓
┌─────────────────────────────────────────────────────────────────┐
│                 流水线完成 (Pipeline Complete)                   │
└─────────────────────────────────────────────────────────────────┘
              │
              ├─ pipeline.completed
              │
              ├─ agent.final_answer (最终答案)
              │
              ↓
    ┌─────────────────────┐
    │  流水线完成，会话继续 │
    └─────────────────────┘
```

---

## 2. 用户确认流程（详细）

```
时间流 ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

服务端                         客户端                    用户
│                              │                        │
│  规划完成                     │                        │
│                              │                        │
├─ plan.completed ────────────→ │                        │
│                              │                        │
│  生成确认请求                │                        │
│                              │                        │
├─ agent.user_confirm ────────→ │                        │
│  (step_id="confirm_123")     │  显示确认对话框          │
│                              │                        │
│  等待用户响应...              │◄─────────────────────→ │ 用户编辑任务
│                              │                        │ 用户点击确认
│                              │                        │
│◄──── user.response ──────────┤                        │
│      (step_id="confirm_123") │                        │
│      (confirmed=true)        │                        │
│      (tasks=[...])           │                        │
│                              │                        │
│  验证响应                    │                        │
│  匹配 step_id                │                        │
│  提取编辑后的任务            │                        │
│                              │                        │
│  开始求解...                 │                        │
│                              │                        │
└─ solver.start ─────────────→ │                        │
   (第一个任务)               │                        │

关键点：
1. step_id 用于关联请求和响应
2. 用户可以编辑任务列表
3. 超时机制防止无限等待
```

---

## 3. 错误恢复流程

```
┌──────────────────────────┐
│  执行任务                 │
└──────────────────────────┘
            │
            ↓ [发生错误]
┌──────────────────────────┐
│  捕获异常                 │
└──────────────────────────┘
            │
            ↓
┌──────────────────────────┐
│  分析错误类型              │
└──────────────────────────┘
            │
    ┌───────┼───────┐
    │       │       │
    ↓       ↓       ↓
  验证   超时    网络错误
  错误   错误    或其他
  │       │       │
  │       │       └─→ [可恢复?] → recoverable=true
  │       │
  │       └─→ [延后重试] → 等待 N 秒
  │
  └─→ [立即重试]
            │
            ↓
┌──────────────────────────────────────┐
│  发送 error.execution 事件            │
│  metadata: {                         │
│    error_type: "timeout",            │
│    recoverable: true,                │
│    suggested_action: "retry"         │
│  }                                   │
└──────────────────────────────────────┘
            │
            ↓
┌──────────────────────────────────────┐
│  发送 error.recovery_started         │
│  metadata: {                         │
│    recovery_strategy: "retry",       │
│    attempt: 1,                       │
│    max_attempts: 3                   │
│  }                                   │
└──────────────────────────────────────┘
            │
            ↓ [第一次重试]
┌──────────────────────────┐
│  重试执行任务             │
└──────────────────────────┘
            │
       ┌────┴────┐
       │          │
       ↓ 成功     ↓ 失败
       │          │
       │      [attempt < max_attempts?]
       │          │
       │      ┌───┴─── 是 ────┐
       │      │               │
       │      ↓              ↓
       │   等待指数退避   attempt +=1
       │   (N×2^attempt 秒) 回到重试
       │      │
       │      └─── 否 ───┐
       │                 │
       ↓                ↓
   成功              失败
    │                 │
    ├─→ 发送        ├─→ 发送
    │  error.       │  error.
    │  recovery_    │  recovery_
    │  success      │  failed
    │   │            │
    └──┴──→ 继续执行  └─→ 向用户报告
                          需要手动干预
```

---

## 4. 重连流程

```
┌────────────────────────────────────────────┐
│ 客户端与服务端连接中...                     │
│ 接收事件 seq=1,2,3,4                        │
│ 定期发送 user.ack (last_seq=4)              │
└────────────────────────────────────────────┘
            │
            ↓ [网络中断]
            │
    ┌───────────────────┐
    │ 连接断开           │
    │ 缓冲区剩余：seq>4  │
    └───────────────────┘
            │
            ↓ [用户尝试重新连接]
┌────────────────────────────────────────────┐
│ 客户端发送                                   │
│ user.reconnect_with_state                  │
│ {                                          │
│   session_id: "sess_xyz123",               │
│   last_seq: 4,        ← 最后接收的事件    │
│   state_checksum: "..." ← 本地状态校验和   │
│ }                                          │
└────────────────────────────────────────────┘
            │
            ↓
┌────────────────────────────────────────────┐
│ 服务端处理                                   │
│ 1. 检查会话是否存在                         │
│ 2. 比较 state_checksum                      │
│ 3. 从缓冲区读取 seq > 4 的所有事件         │
│ 4. 返回这些事件                            │
└────────────────────────────────────────────┘
            │
            ├─ system.connected (重连成功)
            │
            ├─ [重放事件 5]
            │
            ├─ [重放事件 6]
            │
            ├─ [重放事件 7]
            │
            ↓
┌────────────────────────────────────────────┐
│ 客户端接收所有遗漏的事件                     │
│ UI 更新到最新状态                           │
│ 继续正常工作                                │
│ 恢复发送 user.ack (last_seq=7)              │
└────────────────────────────────────────────┘

时间表：
┌─────────────┐
│ 正常工作     │
├─────────────┤
│ seq=1,2,3,4 │
│ ACK: 4      │
├─────────────┤
│ 网络断开     │ ← 关键时刻
├─────────────┤
│ 离线缓冲     │ (seq=5,6,7 在服务端缓冲)
├─────────────┤
│ 重连         │ user.reconnect_with_state
├─────────────┤
│ 重放 5,6,7   │
├─────────────┤
│ 恢复工作     │
│ ACK: 7      │
└─────────────┘
```

---

## 5. 并发任务处理流程

```
┌─────────────────────────────────────┐
│ plan.completed (3 个任务)             │
│ tasks: [task1, task2, task3]         │
└─────────────────────────────────────┘
            │
            ├─ agent.user_confirm
            │  (请求确认)
            │
     ┌──────┴──────┐
     │ 用户确认     │
     └──────┬──────┘
            │
            ↓
┌─────────────────────────────────────┐
│ 服务端开始并行求解                   │
└─────────────────────────────────────┘
            │
      ┌─────┼─────┬─────┐
      │     │     │     │
      ↓     ↓     ↓     ↓
   Task1  Task2  Task3  主线程
    │      │      │     (协调)
    ↓      ↓      ↓      │
 solve   solve   solve   监控
  [进度]  [进度]  [进度]   进度
    │      │      │      │
    ↓      ↓      ↓      │
  成功    成功   超时     │
    │      │      │      │
    └──────┼──────┘      │
           │             │
         ├─ 发送求解结果  │
         │               │
         ├─ 任务 3 失败 ──┤
         │  发送错误信息  │
         │               │
         ├─ 错误恢复     │
         │  重试任务 3   │
         │               │
         └─ 收集所有结果 │

事件序列：
1. solver.start (task1)
2. solver.progress (task1)
3. solver.start (task2)
4. solver.progress (task2)
5. solver.start (task3)
6. solver.completed (task1) ✓
7. solver.progress (task2)
8. solver.progress (task3)
9. solver.completed (task2) ✓
10. error.execution (task3 timeout)
11. error.recovery_started (task3, attempt=1)
12. solver.start (task3 retry)
13. solver.completed (task3) ✓
14. aggregate.start
15. aggregate.completed
```

---

## 6. 用户拒绝规划流程

```
┌─────────────────────────────────┐
│ plan.completed (规划完成)        │
└─────────────────────────────────┘
            │
            ↓
┌─────────────────────────────────┐
│ agent.user_confirm              │
│ (step_id="confirm_plan_123")    │
│ (tasks: [3 个任务])              │
└─────────────────────────────────┘
            │
     ┌──────┴──────┐
     │             │
     ↓ 确认        ↓ 拒绝
  [继续]        [停止]
     │             │
     ↓             ↓
  solver       ┌──────────────┐
  阶段         │ user.response│
  │            │ (confirmed:  │
  │            │  false)      │
  │            └──────────────┘
  │                  │
  │                  ↓
  │            ┌──────────────┐
  │            │ plan.cancelled│
  │            │ (reason:     │
  │            │  user_reject)│
  │            └──────────────┘
  │                  │
  │                  ↓
  │            会话继续等待新输入
  │
  ↓
aggregate.completed
    │
    ↓
pipeline.completed
```

---

## 7. 序列图：完整的消息交互

```
客户端                    服务端                    缓冲区
│                        │                        │
├─ user.message ────────→│                        │
│  "做个 PPT"             │                        │
│                        │ [开始规划]               │
│                        │                        │
│◄───── plan.start ──────┤                        ├─ seq=1
│                        │                        │
│◄────── plan.step_completed ──────────────────┤ seq=2
│         (step 1 完成)   │                        │
│                        │                        │
│◄────── plan.step_completed ──────────────────┤ seq=3
│         (step 2 完成)   │                        │
│                        │                        │
│◄─── plan.completed ────┤                        ├─ seq=4
│     (3 个任务)          │                        │
│                        │                        │
│ user.ack ────────────→│                        │ ACK'd
│ (last_seq=4)          │                        │ 缓冲区清理
│                        │ [等待确认...]            │
│                        │                        │
│◄── agent.user_confirm ─┤                        ├─ seq=5
│    (step_id="c123")    │                        │
│    [显示确认对话框]    │                        │
│                        │ [超时: 5 分钟]          │
│                        │                        │
│    [用户编辑任务]       │                        │
│                        │                        │
│ user.response ────────→│                        │
│ (step_id="c123")       │ [验证 step_id 匹配]     │
│ (confirmed=true)       │ [提取编辑后的任务]      │
│ (tasks=[...])          │                        │
│                        │ [开始求解...]           │
│                        │                        │
│◄── solver.start ───────┤                        ├─ seq=6
│    (task1)             │                        │
│                        │                        │
│◄── solver.progress ────┤                        ├─ seq=7
│    (1/5 steps)         │                        │
│                        │                        │
│◄── solver.progress ────┤                        ├─ seq=8
│    (3/5 steps)         │                        │
│                        │                        │
│◄── solver.completed ───┤                        ├─ seq=9
│    (task1 成功)         │                        │
│                        │                        │
│ user.ack ────────────→│                        │ ACK'd
│ (last_seq=9)          │                        │ seq≤9 清理
│                        │                        │
│◄─── aggregate.start ───┤                        ├─ seq=10
│                        │                        │
│◄── aggregate.completed ┤                        ├─ seq=11
│                        │                        │
│◄── pipeline.completed ─┤                        ├─ seq=12
│                        │                        │
│◄── agent.final_answer ─┤                        ├─ seq=13
│    (PPT 生成完成)       │ [生成完成]             │
│                        │                        │
│ user.ack ────────────→│                        │
│ (last_seq=13)         │ [缓冲区清空]             │
│                        │                        │
└─────────────────────────────────────────────────
```

---

## 8. 状态机：连接状态转换

```
                    ┌──────────────┐
                    │ DISCONNECTED │
                    └──────────────┘
                           │
                           │ 用户连接
                           │
                           ↓
                    ┌──────────────┐
                    │  CONNECTING  │
                    └──────────────┘
                           │
                  ┌────────┴────────┐
                  │                 │
          [连接成功]          [连接失败]
                  │                 │
                  ↓                 │
            ┌──────────────────┐   │
            │ CONNECTED        │   │
            │ (system.connected)   │
            └──────────────────┘   │
                  │                 │
        ┌─────────┴─────────┐       │
        │                   │       │
        ↓                   ↓       │
   [正常工作]          [检测到断线] │
        │                   │       │
        ├─ 接收事件          ├─ RECONNECTING
        │                   │       │
        ├─ 发送 ACK          ├─→ 尝试重连
        │                   │   (user.reconnect_with_state)
        │                   │       │
        ├─ 等待用户输入      └───┬───┘
        │   或服务端事件          │
        │                   ┌─────┴──────┐
        └────────┬──────────┘ [成功]     [失败超时]
                 │                       │
                 ↓                       ↓
            [继续工作]            DISCONNECTED
```

---

## 9. 缓冲区管理流程

```
服务端事件缓冲区维护
═══════════════════════════════════════

事件产生
    │
    ↓
┌──────────────────────────────────────┐
│ 序列化事件                             │
│ seq = ++sequence_counter              │
│ timestamp = now()                     │
└──────────────────────────────────────┘
    │
    ├─ 发送到客户端
    │
    ├─ 添加到缓冲区
    │  buffer[connection_id].append((seq, event))
    │  buffer maxlen = 1000  (环形缓冲)
    │
    ↓
┌──────────────────────────────────────┐
│ 等待客户端 ACK                         │
│ Timeout: 5 分钟                       │
└──────────────────────────────────────┘
    │
    ├─ ACK 收到
    │  last_acked[connection_id] = seq
    │
    ├─ 清理缓冲区
    │  while buffer[...] and buffer[...][0] <= last_acked:
    │      buffer[...].popleft()
    │
    ├─ 重连时
    │  从缓冲区读取 seq > last_seq 的所有事件
    │  逐个重放给客户端
    │
    ↓
┌──────────────────────────────────────┐
│ 客户端收到所有遗漏的事件               │
│ 发送最新的 ACK                        │
└──────────────────────────────────────┘
    │
    ↓
缓冲区清空 (或保留最新的部分事件)

注意：
- seq 是全局递增的
- 缓冲区大小有限（1000 条事件）
- 超过 5 分钟未 ACK 的客户端可能会丢失事件
- 重连时优先重放而不是重新执行
```

---

## 10. 决策树：事件处理流程

```
收到事件
    │
    ├─ 事件来自客户端?
    │  │
    │  ├─ 是: user.* 命名空间
    │  │     │
    │  │     ├─ user.message
    │  │     │  └─ 启动规划流程
    │  │     │
    │  │     ├─ user.response
    │  │     │  ├─ 检查 step_id 是否匹配
    │  │     │  ├─ 提取用户确认信息
    │  │     │  └─ 继续或取消操作
    │  │     │
    │  │     ├─ user.cancel / user.cancel_task
    │  │     │  └─ 中断当前任务
    │  │     │
    │  │     ├─ user.reconnect_with_state
    │  │     │  ├─ 验证 session_id
    │  │     │  ├─ 比较 state_checksum
    │  │     │  └─ 重放 seq > last_seq 的事件
    │  │     │
    │  │     └─ user.ack
    │  │        └─ 更新 last_acked，清理缓冲区
    │  │
    │  └─ 否: server.* 命名空间
    │     └─ 转发给客户端 UI
    │
    └─ 事件类型?
       │
       ├─ 阶段事件 (plan.*, solver.*, aggregate.*)
       │  └─ 记录进度，继续流程
       │
       ├─ 代理事件 (agent.*)
       │  ├─ agent.user_confirm
       │  │  └─ 暂停，等待用户响应 (step_id 配对)
       │  │
       │  ├─ agent.error
       │  │  └─ 分析错误，触发恢复流程
       │  │
       │  └─ 其他
       │     └─ 记录并转发
       │
       ├─ 错误事件 (error.*)
       │  ├─ error.recovery_started
       │  │  └─ 启动重试逻辑
       │  │
       │  └─ error.recovery_failed
       │     └─ 报告给用户，等待决策
       │
       └─ 系统事件 (system.*)
          ├─ system.connected
          │  └─ 初始化会话
          │
          └─ system.error
             └─ 关键错误处理
```

---

## 图例

```
符号说明：
─────────  事件流向
    ↓      下一步
    │      连接
    ├─     分支
    ┌─┐    框/状态
    └─┘
    ×××    错误/超时
    ✓      成功
```

---

## 快速查阅

| 流程 | 位置 | 关键事件 |
|------|------|---------|
| 正常工作 | 第 1 节 | plan → confirm → solver → aggregate |
| 用户确认 | 第 2 节 | agent.user_confirm + user.response (step_id) |
| 错误恢复 | 第 3 节 | error.execution → error.recovery_started → 重试 |
| 重连 | 第 4 节 | user.reconnect_with_state + 事件重放 |
| 并发任务 | 第 5 节 | 多个 solver.* 事件同时发送 |
| 用户拒绝 | 第 6 节 | user.response (confirmed=false) |
| 序列图 | 第 7 节 | 完整的消息顺序 |
| 状态机 | 第 8 节 | 连接状态转换 |
| 缓冲区 | 第 9 节 | seq + ACK + 重放 |
| 决策树 | 第 10 节 | 事件处理逻辑 |
