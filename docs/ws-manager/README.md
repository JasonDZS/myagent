# MyAgent WebSocket 管理系统设计

## 概述

基于 MyAgent 现有架构设计一个多智能体 WebSocket 管理系统，支持在单一管理平台上部署、管理和监控多个智能体服务实例。

## 设计目标

### 核心功能
- **多服务管理**: 支持注册、启动、停止、重启多个智能体服务
- **连接分发**: 智能路由和负载均衡客户端连接
- **统一监控**: 实时监控所有服务的状态、会话、连接数等
- **服务发现**: 支持服务注册与发现机制
- **配置管理**: 统一管理智能体配置和部署参数

### 扩展特性
- **动态扩缩容**: 根据负载自动启动/停止服务实例
- **健康检查**: 定期检查服务健康状态并自动恢复
- **API 网关**: 提供统一的 HTTP API 入口
- **Web 控制台**: 可视化管理界面
- **日志聚合**: 集中收集和查看所有服务日志

## 架构设计

### 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    管理控制台 (Web UI)                        │
└─────────────────┬───────────────────────────────────────────┘
                  │ HTTP API
┌─────────────────▼───────────────────────────────────────────┐
│                  Agent Manager                              │
│  ┌─────────────┐ ┌──────────────┐ ┌─────────────────────┐    │
│  │ Service     │ │ Connection   │ │ Health Monitor      │    │
│  │ Registry    │ │ Router       │ │                     │    │
│  └─────────────┘ └──────────────┘ └─────────────────────┘    │
└─────────────────┬───────────────────────────────────────────┘
                  │ Manages
┌─────────────────▼───────────────────────────────────────────┐
│                Agent Services Layer                         │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐        │
│  │ Agent Service│ │ Agent Service│ │ Agent Service│        │
│  │ A (Port 8081)│ │ B (Port 8082)│ │ C (Port 8083)│   ...  │
│  └──────┬───────┘ └──────┬───────┘ └──────┬───────┘        │
│         │ WebSocket      │ WebSocket      │ WebSocket      │
└─────────┼────────────────┼────────────────┼────────────────┘
          │                │                │
┌─────────▼────────────────▼────────────────▼────────────────┐
│                    Client Connections                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ Client 1 │ │ Client 2 │ │ Client 3 │ │ Client N │  ...  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 2. 核心组件

#### AgentManager (服务管理器)
- **职责**: 管理多个智能体服务的生命周期
- **功能**: 
  - 服务注册与注销
  - 启动、停止、重启服务
  - 服务状态监控
  - 端口管理和分配

#### ConnectionRouter (连接路由器)  
- **职责**: 智能路由客户端连接到合适的服务实例
- **策略**:
  - 轮询 (Round Robin)
  - 最少连接 (Least Connections) 
  - 基于标签的路由 (Tag-based Routing)
  - 会话亲和性 (Session Affinity)

#### HealthMonitor (健康监控)
- **职责**: 监控服务健康状态并处理故障
- **功能**:
  - 定期健康检查
  - 故障检测与恢复
  - 性能指标收集
  - 告警通知

#### ServiceRegistry (服务注册中心)
- **职责**: 维护服务注册信息和元数据
- **数据**:
  - 服务基本信息 (名称、描述、标签)
  - 网络信息 (主机、端口)  
  - 状态信息 (运行状态、启动时间)
  - 统计信息 (连接数、会话数)

## 详细设计

### 1. 数据模型

参见: [data-models.md](./data-models.md)

### 2. API 设计

参见: [api-design.md](./api-design.md)

### 3. 连接路由策略

参见: [routing-strategies.md](./routing-strategies.md)

### 4. 部署架构

参见: [deployment-architecture.md](./deployment-architecture.md)

## 实施计划

### Phase 1: 基础服务管理 (2 周)
- [ ] 实现 AgentManager 基础功能
- [ ] 支持服务注册、启动、停止
- [ ] 基础健康检查
- [ ] 命令行管理工具

### Phase 2: 连接路由 (2 周)  
- [ ] 实现 ConnectionRouter
- [ ] 支持基本路由策略
- [ ] WebSocket 代理功能
- [ ] 会话持久化

### Phase 3: 监控与管理 (2 周)
- [ ] 完善健康监控系统
- [ ] HTTP API 接口
- [ ] 性能指标收集
- [ ] 日志聚合

### Phase 4: Web 控制台 (2 周)
- [ ] 管理界面开发
- [ ] 实时监控面板
- [ ] 配置管理界面
- [ ] 操作日志

### Phase 5: 高级特性 (2 周)
- [ ] 自动扩缩容
- [ ] 负载均衡优化
- [ ] 故障转移
- [ ] 性能优化

## 技术栈

- **后端**: Python 3.11+, AsyncIO, WebSockets
- **数据存储**: SQLite (本地), Redis (分布式缓存)
- **Web框架**: FastAPI (HTTP API)
- **前端**: Vue.js 3 + TypeScript (Web 控制台)
- **监控**: Prometheus + Grafana (可选)
- **日志**: 基于 Loguru 的结构化日志

## 兼容性

- **向后兼容**: 完全兼容现有 MyAgent 智能体实现
- **API兼容**: 现有 WebSocket API 保持不变
- **配置兼容**: 支持现有配置文件格式